generator client {
    provider        = "prisma-client"
    previewFeatures = ["strictUndefinedChecks"]
    output          = "../shared/generated/"
    engineType      = "client"
}

// generator kysely {
//   provider = "prisma-kysely"

//   output   = "../types"
//   fileName = "kysely.ts"
// }

datasource db {
    provider = "postgresql"
}

model User {
    id String @id @default(ulid())

    givenName  String @default("") // first name
    familyName String @default("") // last name

    additionalNames String[] @default([])

    emailAddress String @unique
    password     String

    affiliation     String?
    homePage        String?
    areasOfInterest String[] @default([])

    emailVerified                 Boolean   @default(false)
    emailVerifiedAt               DateTime?
    emailVerificationToken        String?   @unique
    emailVerificationTokenExpires DateTime?

    created DateTime @default(now())
    updated DateTime @updatedAt

    userDatasets UserDataset[]
}

model UserDataset {
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId String

    dataset   Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
    datasetId Int

    created DateTime @default(now())
    updated DateTime @updatedAt

    @@id([userId, datasetId])
    @@index([userId])
    @@index([datasetId])
}

model Dataset {
    id Int @id @default(autoincrement())

    source String? // The source of the dataset - e.g. "datacite", "emdb", "pmid", etc.

    identifier     String
    identifierType String // doi, emdb, pmid, etc.

    url String? // Might be important in the future for linking to the dataset if the identifier is not enough

    title       String
    description String?
    version     String?

    publisher   String?
    publishedAt DateTime

    domain   String?
    subjects String[]

    created DateTime @default(now())
    updated DateTime @updatedAt

    datasetIdentifiers DatasetIdentifier[]
    datasetAuthors     DatasetAuthor[]

    citations Citation[]
    mentions  Mention[]
    fujiScore FujiScore?

    fujiJobs FujiJob[]

    datasetClaims UserDataset[]

    @@unique([identifierType, identifier])
    @@index([identifier])
    @@index([publishedAt])
}

model DatasetAuthor {
    id BigInt @id @default(autoincrement())

    dataset   Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
    datasetId Int

    nameType        String?
    name            String
    nameIdentifiers String[] @default([])

    affiliations String[] @default([])

    created DateTime @default(now())
    updated DateTime @updatedAt

    @@index([datasetId])
}

model DatasetIdentifier {
    id Int @id @default(autoincrement())

    dataset   Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
    datasetId Int

    identifier     String
    identifierType String // doi, emdb, pmid, etc.

    created DateTime @default(now())
    updated DateTime @updatedAt

    @@unique([datasetId, identifierType, identifier])
    @@index([identifierType, identifier])
}

model Citation {
    id BigInt @id @default(autoincrement())

    dataset   Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
    datasetId Int

    citationLink String

    datacite Boolean @default(false)
    mdc      Boolean @default(false)
    openAlex Boolean @default(false)

    citedDate      DateTime?
    citationWeight Float     @default(1.0) // The weight of the citation (1.0 = 100% of the citation impact)

    created DateTime @default(now())
    updated DateTime @updatedAt

    @@unique([datasetId, citationLink])
    @@index([datasetId])
    @@index([citedDate])
}

model FujiScore {
    datasetId Int     @id
    dataset   Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

    score          Float? // default is null so that we can store the score later
    evaluationDate DateTime

    metricVersion   String
    softwareVersion String

    created DateTime @default(now())
    updated DateTime @updatedAt
}

model FujiJob {
    id Int @id @default(autoincrement())

    dataset   Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
    datasetId Int

    created DateTime @default(now())
    updated DateTime @updatedAt

    @@index([datasetId])
}

model Mention {
    id BigInt @id @default(autoincrement())

    dataset   Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
    datasetId Int

    mentionLink String
    source      String // github, linkedin, twitter, software heritage, etc.

    mentionedDate DateTime?
    mentionWeight Float     @default(1.0) // The weight of the mention (1.0 = 100% of the mention impact)

    created DateTime @default(now())
    updated DateTime @updatedAt

    @@unique([datasetId, mentionLink, source])
    @@index([datasetId])
    @@index([mentionedDate])
}
